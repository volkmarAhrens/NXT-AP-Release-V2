/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/util/extend","sap/base/util/ObjectPath","sap/ui/VersionInfo","sap/ui/core/Supportability","sap/ui/support/supportRules/RuleSet","sap/ui/support/supportRules/CommunicationBus","sap/ui/support/supportRules/WCBChannels","sap/ui/support/supportRules/RuleSerializer","sap/ui/support/supportRules/Constants","sap/ui/support/supportRules/util/EvalUtils","sap/ui/support/supportRules/util/Utils","sap/ui/thirdparty/jquery"],function(e,t,r,i,u,s,a,n,l,o,p,c,jQuery){"use strict";var f=function(){var e;return function(t){if(!e){e=document.createElement("a")}e.href=t;return e.href.replace(/\/$/,"")}}();var h="sprt";var R=sap.ui.require.toUrl("sap/ui/support");var b=R.replace("/sap/ui/support","");var S=f(b);var _={};_._mRuleSets={};_._mRequireLibraryRuleSet={};_.getRuleSets=function(){return this._mRuleSets};_.addRuleSet=function(e,t){this._mRuleSets[e]=t};_.getRuleSet=function(e){return this._mRuleSets[e]};_._fetchSupportRuleSets=function(e,t){var r=t||sap.ui.getCore().getLoadedLibraries(),u=this._fetchLibraryNamesWithSupportRules(r);return i.load({library:"sap.ui.core"}).then(function(e){s.versionInfo=e;return u}).then(function(e){return Promise.all(this._fetchLibraryFiles(e,this._fetchRuleSet))}.bind(this)).then(function(){this._bRulesCreated=true;a.publish(n.UPDATE_SUPPORT_RULES,{sRuleSet:l.serialize(this._mRuleSets),oVersionInfo:s.versionInfo});if(e&&typeof e==="function"){e()}}.bind(this))};_.loadAdditionalRuleSets=function(e){var t=this,r=t._fetchLibraryFiles(e,t._fetchRuleSet);Promise.all(r).then(function(){t._bRulesCreated=true;a.publish(n.UPDATE_SUPPORT_RULES,{sRuleSet:l.serialize(t._mRuleSets)})})};_._fetchLibraryNamesWithSupportRules=function(e){return new Promise(function(t){c.canLoadInternalRulesAsync().then(function(r){var i={publicRules:[],internalRules:[],allRules:[]};e=e||{};var u=[];Object.keys(e).forEach(function(e){var t=new Promise(function(t){var r=S+"/"+e.replace(/\./g,"/")+"/.supportrc";jQuery.ajax({type:"GET",dataType:"json",url:r,success:function(r){t({lib:e,rcData:r})},error:function(){t({lib:e,rcData:null})}})});u.push(t)});Promise.all(u).then(function(e){e.forEach(function(e){if(e.rcData){var u=false;if(e.rcData.publicRules){i.publicRules.push(e.lib);u=true}if(r&&e.rcData.internalRules){i.internalRules.push(e.lib);u=true}if(u&&i.allRules.indexOf(e.lib)<0){i.allRules.push(e.lib)}}t(i)})})})})};_._fetchLibraryFiles=function(e,t,r){var i=[],s=sap.ui.require.toUrl("sap/ui/support"),l=s.replace("sap/ui/support",""),o=c.canLoadInternalRules(),p=o&&e.internalRules.length>0,f=0,h=e.publicRules.length;var R=u.getSupportSettings();var b=R&&R.indexOf("silent")>-1;if(p){h+=e.internalRules.length}function S(){f+=1;var e=Math.ceil(f/h*100);a.publish(n.CURRENT_LOADING_PROGRESS,{value:e})}if(e.publicRules.length>0){e.publicRules.forEach(function(e){var u=this._registerLibraryPath(e,s,l).customizableLibName;if(this._mRequireLibraryRuleSet[u]){return}var a=this._requireRuleSet(u,t);if(!b&&!r){a.then(function(){S()})}this._mRequireLibraryRuleSet[u]=a;i.push(a)}.bind(this))}if(o&&e.internalRules.length>0){e.internalRules.forEach(function(e){var u=this._registerLibraryPath(e,s,l).internalLibName;if(this._mRequireLibraryRuleSet[u]){return}var a=this._requireRuleSet(u,t);if(!b&&!r){a.then(function(){S()})}this._mRequireLibraryRuleSet[u]=a;i.push(a)}.bind(this))}return i};_._registerLibraryPath=function(e,t,r){var i=e.replace(/\./g,"/");var u=i;var s=this._getLoadFromSupportOrigin();var a={};if(s){u+="/"+h;a[u]=r+i}var n=u+"/internal";var l=r.replace("resources/","")+"test-resources/"+i+"/internal";a[n]=l;sap.ui.loader.config({paths:a});return{internalLibName:n.replace(/\//g,"."),customizableLibName:u.replace(/\//g,".")}};_._requireRuleSet=function(e,t){var r=this;return new Promise(function(i){try{sap.ui.require([e.replace(/\./g,"/")+"/library.support"],function(u){t.call(r,e,u);i()},i)}catch(e){i()}})};_._fetchRuleSet=function(i,u){try{var a=i.replace("."+h,"").replace(".internal",""),n=this._mRuleSets[a];if(u==null){u=r.get(i).library.support;if(u){e.error(`The ruleset for library '${i}' could only be retrieved via globals.`+`This is deprecated and won't be supported in future releases`)}}if(!u){throw"The library.support file was not fetched successfully."}if(n){n.ruleset.mergeRuleSet(u.ruleset);return}if(u.ruleset instanceof s){n=t({},u)}else{n=this._createRuleSet(u)}this._mRuleSets[a]=n}catch(t){e.error("["+o.SUPPORT_ASSISTANT_NAME+"] Failed to load RuleSet for "+i+" library",t)}};_._getLoadFromSupportOrigin=function(){var e=new URL(sap.ui.require.toUrl("sap/ui/core"),document.baseURI);var t=new URL(sap.ui.require.toUrl("sap/ui/support"),document.baseURI);return e.origin!==t.origin};_.fetchNonLoadedRuleSets=function(e){i.load().then(function(e){var t={};e.libraries.forEach(function(e){t[e.name]=e});return this._fetchLibraryNamesWithSupportRules(t)}.bind(this)).then(function(t){var r=[];t.allRules.forEach(function(t){if(e.indexOf(t)<0){r.push(t)}});a.publish(n.POST_AVAILABLE_LIBRARIES,{libNames:r})})};_._onLibraryChanged=function(e){if(e.getParameter("stereotype")==="library"&&this._bRulesCreated){this._oMainPromise=this._fetchSupportRuleSets()}};_.updateRuleSets=function(e){this._oMainPromise=this._fetchSupportRuleSets(e)};_._createRuleSet=function(e){var t={name:e.name,niceName:e.niceName};var r=new s(t);r.mergeRuleSet(e.ruleset);return{lib:t,ruleset:r}};_.getAllRules=function(){var e={};Object.keys(this._mRuleSets).map(function(r){e=t(e,this._mRuleSets[r].ruleset.getRules())},this);return e};_.getAllRuleDescriptors=function(){var e=this.getAllRules();return Object.keys(e).map(function(t){return{libName:e[t].libName,ruleId:t}})};if(p.isEvalAllowed()){_.addRuleSet(o.TEMP_RULESETS_NAME,{lib:{name:o.TEMP_RULESETS_NAME},ruleset:new s({name:o.TEMP_RULESETS_NAME})})}return _},true);
//# sourceMappingURL=RuleSetLoader.js.map