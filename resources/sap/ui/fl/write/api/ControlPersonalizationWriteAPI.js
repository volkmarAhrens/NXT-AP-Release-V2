/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/fl/apply/api/FlexRuntimeInfoAPI","sap/ui/fl/initial/_internal/changeHandlers/ChangeHandlerStorage","sap/ui/fl/registry/Settings","sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/FlexControllerFactory","sap/ui/fl/Layer","sap/ui/fl/Utils"],function(e,r,t,n,o,a,i,c,l,s,p,u,g,f){"use strict";var h={};function d(e,n){if(!e.changeSpecificData){return Promise.reject(new Error("No changeSpecificData available"))}if(!e.changeSpecificData.changeType){return Promise.reject(new Error("No valid changeType"))}if(!(e.selectorControl instanceof t)){return Promise.reject(new Error("No valid selectorControl"))}var o=e.selectorControl.getMetadata().getName();return c.getChangeHandler(e.changeSpecificData.changeType,o,e.selectorControl,r,n)}function C(e,t,n){var a=o.getRelevantVariantManagementControlId(t,[],n);return r.getSelector(a,e).id}function m(r){e.error(r);return Promise.reject(r)}var v={add(r){if(!r.changes.length){return Promise.resolve([])}var t=r.changes[0].selectorElement||r.changes[0].selectorControl;var o=f.getAppComponentForControl(t);var c=i.getFlexReference({element:t});var l=p.getChangePersistenceForControl(o);var u=o.getModel(a.getVariantModelName());var m=g.USER;var v=[];const y={};function I(){var t=[];var n=[];return r.changes.reduce(function(a,i){return a.then(function(){i.selectorControl=i.selectorElement;return d(i,m)}).then(function(){if(!i.transient&&!r.ignoreVariantManagement){if(!i.changeSpecificData.variantReference){let e;const t=i.selectorControl.getId();e=y[t]||C(o,i.selectorControl,r.useStaticArea);if(!e&&!r.useStaticArea){e=C(o,i.selectorControl,true)}if(e){y[t]=e;const r=u.oData[e].currentVariant;i.changeSpecificData.variantReference=r}}}else{delete i.changeSpecificData.variantReference}i.changeSpecificData=Object.assign(i.changeSpecificData,{developerMode:false,layer:m});return s.create({changeSpecificData:i.changeSpecificData,selector:i.selectorControl})}).then(function(e){if(!i.transient){n.push(e)}t.push({changeInstance:e,selectorControl:i.selectorControl})}).catch(function(r){e.error("A Change was not created successfully. Reason: ",r.message)})},Promise.resolve()).then(function(){l.addChanges(n,o);return t}).catch(function(r){e.error("Changes were not added successfully. Reason: ",r.message)})}function S(r){return r.reduce(function(r,t){return r.then(function(){t.changeInstance.setQueuedForApply();return s.apply({change:t.changeInstance,element:t.selectorControl})}).then(function(e){if(e.success){v.push(t.changeInstance)}else{throw e.error||new Error("ChangesWriteAPI.apply failed with unspecified error")}}).catch(function(r){l.deleteChange(t.changeInstance);e.error("A Change was not applied successfully. Reason: ",r.message)})},Promise.resolve())}return n.initialize({componentId:o.getId()}).then(function(){return I().then(S).then(function(){(h[c]||[]).forEach(function(e){e(v)});return v})})},reset(e){if(!e.selectors||e.selectors.length===0){return m("At least one control ID has to be provided as a parameter")}var r=e.selectors[0].appComponent||f.getAppComponentForControl(e.selectors[0]);if(!r){return m("App Component could not be determined")}var t=e.selectors.map(function(e){var t=e.id||e.getId();var n=r.getLocalId(t);return n||t});var o=u.createForControl(r);if(n.isInitialized({control:r})){return o.resetChanges(g.USER,undefined,r,t,e.changeTypes)}return Promise.resolve()},restore(e){if(!e||!e.selector){return Promise.reject("No selector was provided")}var r=f.getAppComponentForControl(e.selector);if(!r){return Promise.reject("App Component could not be determined")}var t=u.createForControl(r);if(n.isInitialized({control:r})){return t.removeDirtyChanges(g.USER,r,e.selector,e.generator,e.changeTypes)}return Promise.resolve()},hasDirtyFlexObjects(e){if(!e||!e.selector){throw Error("No selector was provided")}var t=f.getAppComponentForControl(e.selector);if(!t){throw Error("App Component could not be determined")}var n=p.getChangePersistenceForControl(t);var o=n.getDirtyChanges();return o.some(function(n){if(n.getLayer()!==g.USER){return false}if(e.generator&&n.getSupportInformation().generator!==e.generator){return false}if(e.changeTypes&&e.changeTypes.indexOf(n.getChangeType())===-1){return false}var o=n.getSelector();return e.selector.getId()===r.getControlIdBySelector(o,t)})},save(e){var r=e.selector.appComponent||f.getAppComponentForControl(e.selector);if(!r){return m("App Component could not be determined")}var t=u.createForControl(r);if(n.isInitialized({control:r})){return t.saveSequenceOfDirtyChanges(e.changes,r)}return Promise.resolve()},buildSelectorFromElementIdAndType(e){var r=f.getAppComponentForControl(e.element);if(!r||!e.elementId||!e.elementType){throw new Error("Not enough information given to build selector.")}return{elementId:e.elementId,elementType:e.elementType,appComponent:r,id:e.elementId,controlType:e.elementType}},isCondensingEnabled(){return l.getInstance().then(function(e){return e.isCondensingEnabled(g.USER)})},attachChangeCreation(e,r){var t=i.getFlexReference({element:e});h[t]=(h[t]||[]).concat(r)},detachChangeCreation(e,r){var t=i.getFlexReference({element:e});if(Array.isArray(h[t])){h[t]=h[t].filter(function(e){return e!==r})}},detachAllChangeCreationListeners(e){if(e){var r=i.getFlexReference({element:e});delete h[r]}else{h={}}}};return v});
//# sourceMappingURL=ControlPersonalizationWriteAPI.js.map