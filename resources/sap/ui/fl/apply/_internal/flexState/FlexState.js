/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/Deferred","sap/base/util/each","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/Component","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/appDescriptorChanges/prepareAppDescriptorMap","sap/ui/fl/apply/_internal/flexState/changes/prepareChangesMap","sap/ui/fl/apply/_internal/flexState/compVariants/prepareCompVariantsMap","sap/ui/fl/apply/_internal/flexState/DataSelector","sap/ui/fl/apply/_internal/flexState/InitialPrepareFunctions","sap/ui/fl/apply/_internal/flexState/Loader","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/LayerUtils","sap/ui/fl/requireAsync"],function(e,n,t,a,r,i,c,s,o,f,p,u,l,m,g,d,h,v,x){"use strict";var b={};var O={};var R={};var j;var y={appDescriptorChanges:{prepareFunction:f,pathInResponse:[]},changes:{initialPreparationFunctionName:"uiChanges",prepareFunction:p,pathInResponse:["changes"]},variants:{initialPreparationFunctionName:"variants",pathInResponse:["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"]},compVariants:{prepareFunction:u,pathInResponse:["comp.variants","comp.standardVariants","comp.defaultVariants","comp.changes"]}};var I={compVariants:{},flexObjects:{}};function C(e,n){var t={comp(){return Object.values(n).reduce(function(e,n){return e.concat(n)},[])},variants(){return n.map(function(e){var t=e.variantReference===e.variantManagementReference||n.some(function(n){return n.variantManagementReference===e.variantManagementReference&&n.fileName===e.variantReference});if(!t){return Object.assign({},e,{variantReference:e.variantManagementReference})}return e})}}[e];if(t){return t()}return Array.isArray(n)?n:[]}function D(e){var n=c.getComponentById(e.componentId);e.componentData||=n&&n.getComponentData()||{};e.manifest||=e.rawManifest||n&&n.getManifestObject()||{};e.reference||=d.getFlexReference(e)}function S(e){var n=[];t(e.changes,function(e,t){C(e,t).forEach(function(e){n.push(s.createFromFileContent(e,null,true))})});return n}function F(e,n){var t=y[e].initialPreparationFunctionName;var a=m[t];if(a){return a(n)}return undefined}function P(e,n,t){var a=F(e,n);if(a){V(t,a)}}var w=new l({id:"flexObjects",parameterKey:"reference",executeFunction(e,n){if(!O[n]){return[]}var t=O[n].runtimePersistence;return t.flexObjects.concat(t.runtimeOnlyData.flexObjects||[],I.flexObjects[n][O[n].componentId]||[])}});function _(e,n){if(!O[e]){throw new Error("State is not yet initialized")}if(!O[e].preparedMaps[n]){var t={unfilteredStorageResponse:O[e].unfilteredStorageResponse,storageResponse:O[e].storageResponse,componentId:O[e].componentId,componentData:O[e].componentData,reference:e,runtimePersistence:O[e].runtimePersistence};O[e].preparedMaps[n]=b.callPrepareFunction(n,t);P(n,t,e)}return O[e].preparedMaps[n]}function V(e,n){O[e]=a(O[e],n);w.checkUpdate({reference:e})}function M(e){return _(e,"appDescriptorChanges")}function k(e){return _(e,"changes")}function z(e){return _(e,"compVariants")}function N(e,n){var t={flexObjects:S(e),runtimeOnlyData:{flexObjects:[]}};Object.keys(y).forEach(function(r){var i=F(r,{storageResponse:e,externalData:n});if(i){t=a(t,i)}});return t}function U(e,n,a){var r=a.flexObjects.slice();var i=r.length;var c;var s=[];t(n.changes,function(e,n){C(e,n).forEach(function(e){s.push(e)})});O[e].runtimePersistence=Object.assign(a,{flexObjects:s.map(function(e){var n;var t=r.find(function(t,a){n=a;return t.getId()===e.fileName});if(t){r.splice(n,1);if(t.getState()!==o.LifecycleState.PERSISTED){t.setResponse(e);c=true}return t}throw new Error("Error updating runtime persistence: storage returned unknown flex objects")})});if(i!==O[e].runtimePersistence.flexObjects.length){c=true}return c}function E(e){var n=e.reference;var t=false;if(!O[n].componentData){var a=c.getComponentById(e.componentId);O[n].componentData=a?a.getComponentData():e.componentData;t=true}if(!O[n].storageResponse){O[n].storageResponse=L(n,O[n].unfilteredStorageResponse);delete O[n].runtimePersistence;t=true}if(!r.get(["flexObjects",n,e.componentId],I)){r.set(["flexObjects",n,e.componentId],[],I)}if(!O[n].runtimePersistence){O[n].runtimePersistence=N(O[n].storageResponse,I.flexObjects[n][e.componentId]||[]);t=true}if(t){w.checkUpdate({reference:n})}}function L(e,n){const i=a({},n);const c=i.changes;if(v.isLayerFilteringRequired(e)){const n=h.getByReference(e);t(y,function(e,t){t.pathInResponse.forEach(function(e){const t=r.get(e,c).filter(function(e){return!e.layer||!v.isOverLayer(e.layer,n.maxLayer)});r.set(e,t,c)})})}return i}async function A(e){const n=await g.loadFlexData(e);q(e.reference,n);return n}function B(e,n){O[n.reference]=a({},{unfilteredStorageResponse:e,preparedMaps:{},componentId:n.componentId,componentData:n.componentData,partialFlexState:n.partialFlexState});Object.freeze(O[n.reference].storageResponse);Object.freeze(O[n.reference].unfilteredStorageResponse)}function q(e,n){var t=n&&n.changes||{};var a=h.getByReference(e);if(a===null){a={}}if(t.info!==undefined){a=Object.assign(a,t.info)}h.setByReference(a,e)}function K(e){var n=O[e.reference];if(n.partialFlexState===true&&e.partialFlexState!==true){n.partialFlexState=false;e.partialFlexData=a({},n.unfilteredStorageResponse.changes);e.reInitialize=true}return e}function T(e){var n=O[e.reference].componentId;if(!e.reInitialize&&n!==e.componentId){e.reInitialize=true}return e}function $(){return x("sap/ui/fl/ChangePersistenceFactory").then(function(e){j=e}).catch(function(e){i.error(`Error loading modules: ${e.message}`)})}b.initialize=async function(e){const t=a({},e);D(t);const r=t.reference;const i=R[r];const c=new n;R[r]=c;await $();if(i){await i.promise;K(t);T(t);if(t.reInitialize){const e=await A(t);B(e,t)}}else{const e=await A(t);B(e,t)}E(t);c.resolve()};b.isInitialized=function(e){var n=e.reference?e.reference:d.getFlexReferenceForControl(e.control);return!!O[n]};b.clearAndInitialize=function(e){D(e);b.clearState(e.reference);return b.initialize(e)};b.update=async function(e){D(e);var t=e.reference;var a=O[t].runtimePersistence;if(j&&(j._instanceCache||{}).hasOwnProperty(t)){j._instanceCache[t].removeDirtyChanges()}const r=R[t].promise;const i=new n;R[t]=i;await r;const c=await A(e);B(c,e);O[t].storageResponse=L(t,O[t].unfilteredStorageResponse);const s=U(t,O[t].storageResponse,a);if(s){w.checkUpdate({reference:t})}i.resolve()};function G(e){switch(e.fileType){case"change":if(e.selector&&e.selector.persistencyKey){return["comp","changes"]}if(e.variantReference){return"variantDependentControlChanges"}return"changes";case"ctrl_variant":return"variants";case"ctrl_variant_change":return"variantChanges";case"ctrl_variant_management_change":return"variantManagementChanges";case"variant":return["comp","variants"];default:return""}}b.updateStorageResponse=function(e,n){n.forEach(n=>{if(n.type==="ui2"){O[e].unfilteredStorageResponse.changes.ui2personalization=n.newData}else{const t=G(n.flexObject);const a=n.flexObject.fileName;const i=r.get(t,O[e].unfilteredStorageResponse.changes);const c=r.get(t,O[e].storageResponse.changes);switch(n.type){case"add":i.push(n.flexObject);c.push(n.flexObject);break;case"delete":c.splice(c.findIndex(e=>e.fileName===a),1);i.splice(i.findIndex(e=>e.fileName===a),1);break;case"update":c.splice(c.findIndex(e=>e.fileName===a),1,n.flexObject);i.splice(i.findIndex(e=>e.fileName===a),1,n.flexObject);break;default:}}})};b.clearState=function(e){if(e){delete O[e];delete R[e];w.clearCachedResult({reference:e});if(j&&(j._instanceCache||{}).hasOwnProperty(e)){j._instanceCache[e].removeDirtyChanges()}}else{O={};R={};w.clearCachedResult()}};b.setInitialNonFlCompVariantData=function(e,n,t,a,r){I.compVariants[e]||={};I.compVariants[e][n]={};I.compVariants[e][n].standardVariant=t;I.compVariants[e][n].variants=a;I.compVariants[e][n].controlId=r};b.getInitialNonFlCompVariantData=function(e){return I.compVariants[e]};b.resetInitialNonFlCompVariantData=function(e){delete I.compVariants[e]};b.addRuntimeSteadyObject=function(e,n,t){I.flexObjects[e]||={};I.flexObjects[e][n]||=[];I.flexObjects[e][n].push(t);w.checkUpdate({reference:e})};b.clearRuntimeSteadyObjects=function(e,n){if(I.flexObjects[e]){delete I.flexObjects[e][n];w.clearCachedResult({reference:e})}};b.rebuildFilteredResponse=function(e){if(O[e]){O[e].preparedMaps={};O[e].storageResponse=L(e,O[e].unfilteredStorageResponse);O[e].runtimePersistence=N(O[e].storageResponse,I.flexObjects[e][O[e].componentId]||[]);w.checkUpdate({reference:e})}};b.addDirtyFlexObject=function(e,n){if(O[e]){O[e].runtimePersistence.flexObjects.push(n);w.checkUpdate({reference:e})}};b.addDirtyFlexObjects=function(e,n){if(n.length>0&&O[e]){O[e].runtimePersistence.flexObjects=O[e].runtimePersistence.flexObjects.concat(n);w.checkUpdate({reference:e})}};b.removeDirtyFlexObject=function(e,n){if(O[e]){var t=O[e].runtimePersistence.flexObjects;var a=t.indexOf(n);t.splice(a,1);w.checkUpdate({reference:e})}};b.removeDirtyFlexObjects=function(e,n){if(O[e]&&n.length>0){var t=O[e].runtimePersistence.flexObjects;n.forEach(function(e){var n=t.indexOf(e);t.splice(n,1)});w.checkUpdate({reference:e})}};b.getFlexObjectsDataSelector=function(){return w};b.getUIChanges=function(e){return k(e).changes};b.getAppDescriptorChanges=function(e){return M(e).appDescriptorChanges};b.getUI2Personalization=function(e){return a({},O[e].unfilteredStorageResponse.changes.ui2personalization)};b.getCompVariantsMap=function(e){return z(e)};b.callPrepareFunction=function(e,n){return y[e].prepareFunction(n)};b.getStorageResponse=function(e){if(R[e]){return R[e].promise.then(function(){return O[e].unfilteredStorageResponse})}return Promise.resolve()};b.getComponentData=function(e){return O[e]&&O[e].componentData};return b});
//# sourceMappingURL=FlexState.js.map