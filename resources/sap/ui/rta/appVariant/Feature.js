/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","sap/ui/rta/appVariant/AppVariantUtils","sap/ui/core/BusyIndicator","sap/ui/core/EventBus","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/appVariant/AppVariantFactory","sap/ui/fl/write/api/FeaturesAPI","sap/base/util/merge"],function(e,n,r,a,t,i,s,o){"use strict";var u;var p;var c;var l;var v;var f=function(){return e.getAppDescriptor(c)};var h=function(){return t.getInstance()};var d=function(){window.onbeforeunload=v};var g=function(e){var r=e?"MSG_DO_NOT_CLOSE_BROWSER_CURRENTLY_ADAPTING":"MSG_DO_NOT_CLOSE_BROWSER";v=window.onbeforeunload;window.onbeforeunload=n.handleBeforeUnloadEvent;return n.showMessage(r)};var A=function(e,n){return p.triggerCatalogPublishing(e,n,true)};var w=function(e){return p.triggerCatalogPublishing(e,null,false)};var b=function(e,a){if(u){n.closeOverviewDialog();return this.onGetOverview(true,a)}else if(!u&&e){r.hide();return this.onGetOverview(true,a)}return Promise.resolve()};var S=function(e,r,a){return e?n.navigateToFLPHomepage():b.call(this,!r,a)};var I=function(e,n){if(e&&e.response&&e.response.IAMId){return p.notifyKeyUserWhenPublishingIsReady(e.response.IAMId,n,true)}return Promise.resolve()};var m=function(e,n){if(e&&e.response&&e.response.IAMId&&e.response.inProgress){return p.notifyKeyUserWhenPublishingIsReady(e.response.IAMId,n,false)}return Promise.resolve()};a.getInstance().subscribe("sap.ui.rta.appVariant.manageApps.controller.ManageApps","navigate",function(){if(u){u.destroy();u=null}});return{onGetOverview(e,r){var a=f();return new Promise(function(t){var i=function(){n.closeOverviewDialog()};var s="sap/ui/rta/appVariant/AppVariantOverviewDialog";var o={idRunningApp:a["sap.app"].id,isOverviewForKeyUser:e,layer:r};sap.ui.require([s],function(e){u||=new e(o);u.attachCancel(i);u.oPopup.attachOpened(function(){t(u)});u.open()})})},isOverviewExtended(){var e=new URLSearchParams(window.location.search);var n=e.get("sap-ui-xx-app-variant-overview-extended");if(!n){return false}return n.toLowerCase()==="true"},isManifestSupported(){var e=f();return n.getManifirstSupport(e["sap.app"].id)},isSaveAsAvailable(e,r,a){c=e;l=a;var t=f();if(t["sap.app"]&&t["sap.app"].id){return s.isSaveAsAvailable(r).then(function(e){if(e){if(t["sap.app"].crossNavigation&&t["sap.app"].crossNavigation.inbounds){return n.getInboundInfo(t["sap.app"].crossNavigation.inbounds)}return n.getInboundInfo()}return undefined}).then(function(e){return!!e})}return Promise.resolve(false)},getAppVariantDescriptor(e){c=e;var n=f();if(n["sap.app"]&&n["sap.app"].id){return i.load({id:n["sap.app"].id})}return Promise.resolve(false)},_determineSelector(e,n){return e?c:{appId:n["sap.app"].id,appVersion:n["sap.app"].applicationVersion.version}},onSaveAs(a,t,i,s){var u;var c;var v=f();var w=true;if(s&&s["sap.app"].id===v["sap.app"].id){t=true;v=o({},s);s=null}else if(s){w=false;v=o({},s);s=null}var b=this._determineSelector(w,v);return new Promise(function(s){var f=function(){return p.processSaveAsDialog(v,a)};var w=function(e){r.show();return p.createAllInlineChanges(e,b)};var m=function(e){var r=e.slice();return n.addChangesToPersistence(r,b)};var P=function(){var e=n.getNewAppVariantId();return p.createAppVariant(e,b).catch(function(r){var a=r.messageKey;a||="MSG_SAVE_APP_VARIANT_FAILED";return n.catchErrorDialog(r,a,e)})};var O=function(e){c=null;c=o({},e.response);return p.clearRTACommandStack(t)};var _=function(){var n=e.getUshellContainer();if(n&&t){n.setDirtyFlag(false)}};var D=function(e){_();u=n.isS4HanaCloud(e);var r=n.buildSuccessInfo(c.id,a,u);return p.showSuccessMessage(r)};var V=function(){var e=n.buildFinalSuccessInfoS4HANACloud();return p.showSuccessMessage(e)};var M=function(){r.show();if(u){var e;return g().then(function(){return A(c.id,c.reference)}).then(function(n){e=Object.assign({},n);r.hide();return S.call(this,a,null,i)}.bind(this)).then(function(){return I(e,c.id)}).then(function(){d();return V()}).then(function(){return a?s():S.call(this,a,u,i)}.bind(this))}r.hide();return S.call(this,a,u,i)};sap.ui.require(["sap/ui/rta/appVariant/AppVariantManager"],function(e){p||=new e({commandSerializer:l,layer:i});return f().then(w).then(m).then(P).then(O).then(h).then(D).then(M.bind(this)).then(s).catch(function(e){if(!e){return false}if(u){d()}return S.call(this,null,u,i).then(s)}.bind(this))}.bind(this))}.bind(this))},onDeleteFromOverviewDialog(e,a,t){var i;return new Promise(function(s){sap.ui.require(["sap/ui/rta/appVariant/AppVariantManager"],function(o){p||=new o({rootControl:c,commandSerializer:l,layer:t});var u=function(){return p.deleteAppVariant(e).catch(function(r){if(r==="cancel"){return Promise.reject("cancel")}var a=r.messageKey;a||="MSG_DELETE_APP_VARIANT_FAILED";return n.catchErrorDialog(r,a,e)})};var v=function(){n.closeOverviewDialog();var r=n.buildDeleteSuccessMessage(e,i);return p.showSuccessMessage(r)};var f=function(s){i=n.isS4HanaCloud(s);if(i){var o;return g(a).then(function(){return w(e)}).then(function(e){o=Object.assign({},e);return b.call(this,!a,t)}.bind(this)).then(function(){return m(o,e)})}r.show();return Promise.resolve()};var A=function(){if(i){d()}r.hide();return a?s():b.call(this,!i,i,t).then(s)};if(a){n.closeOverviewDialog();n.navigateToFLPHomepage()}return h().then(f.bind(this)).then(u).then(v).then(A.bind(this)).catch(function(e){if(e==="cancel"){return false}if(i){d()}return b.call(this,null,i,t).then(s)}.bind(this))}.bind(this))}.bind(this))}}});
//# sourceMappingURL=Feature.js.map