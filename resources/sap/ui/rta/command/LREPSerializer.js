/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/rta/command/FlexCommand","sap/ui/rta/command/AppDescriptorCommand","sap/ui/fl/Utils","sap/ui/dt/ElementUtil","sap/base/Log","sap/ui/fl/write/api/PersistenceWriteAPI"],function(e,t,n,a,o,i,r){"use strict";var s=e.extend("sap.ui.rta.command.LREPSerializer",{metadata:{library:"sap.ui.rta",associations:{rootControl:{type:"sap.ui.core.Control"}},properties:{commandStack:{type:"object"}},aggregations:{}}});function d(e){return o.getElementInstance(e)}s.prototype._lastPromise=Promise.resolve();s.prototype.setCommandStack=function(e){if(this.getCommandStack()){this.getCommandStack().removeCommandExecutionHandler(this._fnHandleCommandExecuted)}this.setProperty("commandStack",e);e.addCommandExecutionHandler(this._fnHandleCommandExecuted)};s.prototype.init=function(){this._fnHandleCommandExecuted=this.handleCommandExecuted.bind(this)};s.prototype.exit=function(){this.getCommandStack().removeCommandExecutionHandler(this._fnHandleCommandExecuted)};s.prototype._isPersistedChange=function(e){return!!this.getCommandStack()._aPersistedChanges&&this.getCommandStack()._aPersistedChanges.indexOf(e.getId())!==-1};s.prototype.handleCommandExecuted=function(e){return function(e){var a=e;this._lastPromise=this._lastPromise.catch(function(){}).then(function(){var e=this.getCommandStack().getSubCommands(a.command);var o;var i=[];if(a.undo){e.forEach(function(e){if(!(e instanceof t||e instanceof n)||e.getRuntimeOnly()){return}var a=e.getPreparedChange();o=e.getAppComponent();if(o){i.push(a)}});if(o){return r.remove({flexObjects:i,selector:o})}return Promise.resolve()}var s=[];e.forEach(function(e){if(e.getRuntimeOnly()){return}if(e instanceof t){o=e.getAppComponent();if(o){var a=e.getPreparedChange();if(!this._isPersistedChange(a)){i.push(e.getPreparedChange())}}}else if(e instanceof n){s.push(e.createAndStoreChange())}}.bind(this));if(o){r.add({flexObjects:i,selector:o})}return Promise.all(s)}.bind(this));return this._lastPromise}.bind(this)(e)};s.prototype.needsReload=function(){this._lastPromise=this._lastPromise.catch(function(){}).then(function(){var e=this.getCommandStack().getAllExecutedCommands();return e.some(function(e){return!!e.needsReload})}.bind(this));return this._lastPromise};s.prototype.saveCommands=function(e){this._lastPromise=this._lastPromise.catch(function(e){i.error(e)}).then(function(){var t=d(this.getRootControl());if(!t){throw new Error("Can't save commands without root control instance!")}return r.save({selector:t,skipUpdateCache:false,draft:!!e.saveAsDraft,layer:e.layer,removeOtherLayerChanges:!!e.removeOtherLayerChanges,version:e.version,adaptationId:e.adaptationId,condenseAnyLayer:e.condenseAnyLayer})}.bind(this)).then(function(){i.info("UI adaptation successfully transfered changes to layered repository");this.getCommandStack().setSaved(true);this.getCommandStack().removeAllCommands()}.bind(this));return this._lastPromise};s.prototype._triggerUndoChanges=function(e){var t=this.getCommandStack();var n=[];var o=t.getAllExecutedCommands();if(e){o.forEach(function(){n.push(t.undo.bind(t))})}else{o.forEach(function(e){n.push(e.undo.bind(e))});n=n.reverse()}return a.execPromiseQueueSequentially(n,false,true)};s.prototype.clearCommandStack=function(e){var t=this.getCommandStack();if(!e){t.detachCommandExecuted(this.handleCommandExecuted.bind(this))}return this._triggerUndoChanges(e).then(function(){t.removeAllCommands();if(!e){t.attachCommandExecuted(this.handleCommandExecuted.bind(this))}return true}.bind(this))};return s});
//# sourceMappingURL=LREPSerializer.js.map