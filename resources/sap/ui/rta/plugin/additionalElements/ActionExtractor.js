/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_difference","sap/base/util/merge","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Lib","sap/ui/dt/ElementUtil","sap/ui/dt/OverlayRegistry","sap/ui/fl/apply/api/DelegateMediatorAPI","sap/ui/rta/plugin/additionalElements/AdditionalElementsUtils","sap/ui/rta/Utils"],function(e,t,n,r,a,i,o,l,u,s){"use strict";var g={};function f(){var e=[];var t=l.getKnownDefaultDelegateLibraries();t.forEach(function(t){var r=a.load({name:t}).then(function(){return Promise.resolve(t)}).catch(function(e){n.warning("Required library not available: ",e);return Promise.resolve()});e.push(r)});return Promise.all(e)}function c(e,t,n){return n.hasChangeHandler(e.changeType,e.element).then(function(n){if(n){return{aggregationName:e.aggregation,addPropertyActionData:{designTimeMetadata:t,action:e,delegateInfo:{payload:e.delegateInfo.payload||{},delegate:e.delegateInfo.instance,modelType:e.delegateInfo.modelType,requiredLibraries:e.delegateInfo.requiredLibraries,delegateType:e.delegateInfo.delegateType}}}}return undefined})}function d(e,t,n){var r=e.getElement();if(!r){return[]}var a=i.getAggregation(r,t,n).filter(function(t){var r=o.getOverlay(t);if(!n.hasStableId(r)){return false}var a=e.getRelevantContainer(true);var i=o.getOverlay(a);var l=e;var u=false;do{u=!l.getElementVisibility();if(u){break}if(l===i){break}else{l=l.getParentElementOverlay()}}while(l);if(u){return true}return r.getElementVisibility()===false},this);return a.map(function(e){return{element:e,sourceAggregation:t}})}function v(e,t){return t.sParentAggregationName}function h(e,t,n,r){var a=n.changeType&&r.hasStableId(e);if(a&&e!==t.relevantContainerOverlay){a=r.hasStableId(t.relevantContainerOverlay)}return a}function m(t,n,a,i){function u(t,u){var s=u.changeOnRelevantContainer?n.relevantContainer:n.parent;var g=o.getOverlay(s);var f=h(g,n,u,a);if(f){u.element=s;return l.getDelegateForControl({control:n.relevantContainer,modifier:r,supportsDefault:u.supportsDefaultDelegate}).then(function(r){if(r&&r.names&&r.names.length&&r.delegateType===l.types.COMPLETE){var a=l.getRequiredLibrariesForDefaultDelegate({delegateName:r.names,control:n.relevantContainer});if(e(a,i.filter(Boolean)).length===0){u.delegateInfo=r;t.push(u)}}return t})}return t}return t.reduce(function(e,t){return e.then(function(e){return u(e,t)})},Promise.resolve([]))}function p(e,t,n,r,a){var i=e.reduce(function(e,t){var n=[];r.forEach(function(e){n=n.concat(d.call(this,t,e,a))}.bind(this),[]);return t?e.concat(n):e}.bind(this),[]);var o={elements:[],controlTypeNames:[]};var l=i.reduce(function(e,t){return e.then(function(e){return y(e,t,a,n)})},Promise.resolve(o));return l.then(function(e){if(e.elements.length>0){t[n]={reveal:e}}return t})}function y(e,t,n,r){var a=t.element;var l;var g;var f=false;var c=Promise.resolve(false);var d=t.sourceAggregation;var h=o.getOverlay(a);if(h){l=h.getDesignTimeMetadata();g=l&&l.getAction("reveal",a);if(g&&g.changeType){var m=a;if(g.changeOnRelevantContainer){m=h.getRelevantContainer()}c=n.hasChangeHandler(g.changeType,m).then(function(e){if(i.isElementValid(a)){var t=u.getParents(true,h,n);if(e){if(g.changeOnRelevantContainer){f=n.hasStableId(t.relevantContainerOverlay)&&n.hasStableId(t.parentOverlay)}else{f=true}g.getAggregationName||=v;if(f&&d!==r){var o=t.parentOverlay.getAggregationOverlay(r);return s.checkTargetZone(o,h,n)}}}return f})}}return c.then(function(t){if(t){e.elements.push({element:a,designTimeMetadata:l,action:g,sourceAggregation:d,targetAggregation:r});var n=l.getName(a);if(n){e.controlTypeNames.push(n)}}return e})}g.getActions=function(e,n,r,a,i){var o=e?"asSibling":"asChild";if(!a&&n._mAddActions){return Promise.resolve(n._mAddActions[o])}var l=this._getRevealActions(e,n,r,i);var u=this._getAddViaDelegateActions(e,n,r);return Promise.all([l,u]).then(function(e){var r=t(e[0],e[1]);n._mAddActions||={asSibling:{},asChild:{}};n._mAddActions[o]=r;return r})};g.getActionsOrUndef=function(e,t){var n=e?"asSibling":"asChild";return t._mAddActions&&t._mAddActions[n]};var A={};var b=true;g._getRevealActions=function(e,t,n,r){if(b){b=false;r.attachEventOnce("synced",function(){A={};b=true},this)}var a=u.getParents(e,t,n);var l=[a.parentOverlay];if(a.relevantContainer!==a.parent){l=i.findAllSiblingsInContainer(a.parent,a.relevantContainer).map(function(e){return o.getOverlay(e)}).filter(function(e){return e})}var s=[];if(a.parentOverlay){var g=A[a.parentOverlay.getId()];if(g&&e){return g}s=a.parentOverlay.getChildren().filter(function(e){return!e.getDesignTimeMetadata().isIgnored(a.parent)}).map(function(e){return e.getAggregationName()});return s.reduce(function(e,t){return e.then(function(e){return p(l,e,t,s,n)})},Promise.resolve({})).then(function(t){if(e){A[a.parentOverlay.getId()]=t}return t})}return Promise.resolve({})};g._getAddViaDelegateActions=function(e,t,n){var r=u.getParents(e,t,n);var a=r.parentOverlay&&r.parentOverlay.getDesignTimeMetadata();return Promise.resolve().then(function(){var e=a?a.getActionDataFromAggregations("add",r.parent,undefined,"delegate"):[];if(e.length){return f().then(m.bind(this,e,r,n))}return[]}.bind(this)).then(function(e){return e.reduce(function(e,t){return e.then(function(e){return c.call(this,t,a,n).then(function(t){if(t){t.addPropertyActionData.relevantContainer=r.relevantContainer;e[t.aggregationName]||={};e[t.aggregationName].addViaDelegate=t.addPropertyActionData}return e})}.bind(this))}.bind(this),Promise.resolve({}))}.bind(this))};return g});
//# sourceMappingURL=ActionExtractor.js.map