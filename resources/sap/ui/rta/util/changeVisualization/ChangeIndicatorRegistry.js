/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/includes","sap/base/util/values","sap/base/util/restricted/_omit","sap/base/Log","sap/ui/base/ManagedObject","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/dt/ElementUtil","sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/fl/Utils","sap/ui/fl/changeHandler/common/ChangeCategories","sap/ui/rta/util/changeVisualization/ChangeStates"],function(e,t,n,i,o,a,r,s,g,c,d){"use strict";var u=o.extend("sap.ui.rta.util.changeVisualization.ChangeIndicatorRegistry",{metadata:{properties:{changeCategories:{type:"object",defaultValue:[]},rootControlId:{type:"string"}}},constructor:function(...e){o.prototype.constructor.apply(this,e);this._oRegisteredChanges={};this._oChangeIndicators={}}});u.prototype.exit=function(){this.reset()};u.prototype.getAllRegisteredChanges=function(){return t(this._oRegisteredChanges||{}).map(function(e){return Object.assign({},e)})};u.prototype.getRegisteredChangeIds=function(){return Object.keys(this._oRegisteredChanges||{})};u.prototype.getRegisteredChange=function(e){return this._oRegisteredChanges[e]&&Object.assign({},this._oRegisteredChanges[e])};u.prototype.getSelectorsWithRegisteredChanges=function(){var e={};var i;function o(t,o,a,r){if(e[t]===undefined){e[t]=[]}e[t].push(Object.assign({id:a.change.getId(),dependent:r,affectedElementId:o||i,displayElementsKey:a.visualizationInfo.displayElementIds.toString(),descriptionPayload:a.visualizationInfo.descriptionPayload||{}},n(a,["visualizationInfo"])));i=o||i}t(this._oRegisteredChanges).forEach(function(e){e.visualizationInfo.displayElementIds.forEach(function(t,n){o(t,e.visualizationInfo.affectedElementIds[n],e,false)})});return e};u.prototype.getRelevantChangesWithSelector=function(){var e=this.getSelectorsWithRegisteredChanges();var t=[];Object.keys(e).forEach(function(n){var i=e[n].filter(function(e){return!e.dependent});t=t.concat(i)});return t};u.prototype.getChangeIndicator=function(e){return this._oChangeIndicators[e]};u.prototype.getChangeIndicators=function(){return t(this._oChangeIndicators||{})};u.prototype.registerChange=function(t,n,i){var o=g.getAppComponentForControl(r.getElementInstance(this.getRootControlId()));return l(t,o).then(function(o){var a=this.getChangeCategories();var r;if(n==="settings"&&e(Object.keys(a),o.descriptionPayload.category)){r=o.descriptionPayload.category}else{r=Object.keys(a).find(function(t){return e(a[t],n)});r||=c.OTHER}var s;var g=[];if(i){g=i.getData().draftFilenames}if(t.getState()==="NEW"){s=d.getDraftAndDirtyStates()}else if(g&&g.includes(t.getId())){s=[d.DRAFT]}else{s=[d.ALL]}this._oRegisteredChanges[t.getId()]={change:t,commandName:n,changeCategory:r,changeStates:s,visualizationInfo:o}}.bind(this))};function l(e,t){function n(e){if(!e){return undefined}return e.map(function(e){var n=typeof e.getId==="function"?e:a.bySelector(e,t);return n&&n.getId()}).filter(Boolean)}return h(t,e).then(function(t){var i=t||{};var o=e.getSelector&&e.getSelector()&&[e.getSelector()];var a=i.affectedControls||o||[];var r=e.getOriginalSelector&&e.getOriginalSelector();var s=r?o:a;return{affectedElementIds:n(a),dependentElementIds:n(i.dependentControls)||[],displayElementIds:n(i.displayControls||n(s)),updateRequired:i.updateRequired,descriptionPayload:i.descriptionPayload||{}}})}function h(e,t){var n=t.getOriginalSelector&&t.getOriginalSelector();n||=t.getSelector&&t.getSelector();var o=a.bySelector(n,e);if(o){return s.getChangeHandler({changeType:t.getChangeType(),element:o,modifier:a,layer:t.getLayer()}).then(function(n){if(n&&typeof n.getChangeVisualizationInfo==="function"&&t.isSuccessfullyApplied&&t.isSuccessfullyApplied()){return n.getChangeVisualizationInfo(t,e)}return undefined}).catch(function(e){i.error(e);return undefined})}return Promise.resolve()}u.prototype.registerChangeIndicator=function(e,t){this._oChangeIndicators[e]=t};u.prototype.reset=function(){Object.keys(this._oRegisteredChanges).forEach(function(e){this.removeRegisteredChange(e)}.bind(this));t(this._oChangeIndicators).forEach(function(e){e.destroy()});this._oChangeIndicators={}};u.prototype.removeRegisteredChange=function(e){delete this._oRegisteredChanges[e]};u.prototype.removeOutdatedRegisteredChanges=function(){this.getAllRegisteredChanges().forEach(function(e){if(e.visualizationInfo&&e.visualizationInfo.updateRequired){this.removeRegisteredChange(e.change.getId())}}.bind(this))};u.prototype.removeRegisteredChangesWithoutVizInfo=function(){this.getAllRegisteredChanges().forEach(function(e){if(e.visualizationInfo&&e.visualizationInfo.displayElementIds.length===0){this.removeRegisteredChange(e.change.getId())}}.bind(this))};return u});
//# sourceMappingURL=ChangeIndicatorRegistry.js.map